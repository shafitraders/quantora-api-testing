<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Quantora Production API - Testing & Diagnostics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .steve-quote {
            font-style: italic;
            color: #00d4ff;
            font-size: 1.1em;
            margin-top: 10px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .test-card h3 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .test-button {
            background: linear-gradient(45deg, #00d4ff, #4ecdc4);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.3);
        }
        
        .result-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border-left: 4px solid #00d4ff;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-healthy { background-color: #4ecdc4; }
        .status-warning { background-color: #ffd93d; }
        .status-error { background-color: #ff6b6b; }
        .status-unknown { background-color: #666; }
        
        .auth-section {
            background: rgba(255, 196, 0, 0.1);
            border-left: 4px solid #ffc400;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #00d4ff;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #ccc;
            margin-top: 5px;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Quantora Production API</h1>
            <h2>Enterprise Testing & Diagnostics Platform</h2>
            <p class="steve-quote">"Innovation distinguishes between a leader and a follower" - Steve Jobs</p>
        </div>

        <div class="auth-section">
            <h3>üîê Environment & Authentication Status</h3>
            <p id="environment-info"><strong>Environment:</strong> <span id="env-name">Detecting...</span></p>
            <p id="api-endpoint-info"><strong>API Endpoint:</strong> <span id="api-url">Loading...</span></p>
            <p><strong>Authentication:</strong> <span id="auth-method">Determining...</span></p>
            <p><strong>Status:</strong> <span id="auth-status">‚è≥ Checking...</span></p>
            
            <div id="auth-input-section" style="display:none; margin-top: 15px;">
                <p><strong>üîë Google Cloud Identity Token:</strong></p>
                <input type="password" id="auth-token-input" placeholder="Paste your gcloud auth print-identity-token here..." 
                       style="width: 100%; padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #444; background: rgba(0,0,0,0.3); color: white;">
                <button class="test-button" onclick="setAuthToken()">üíæ Set Token</button>
                <button class="test-button" onclick="clearAuthToken()">üóëÔ∏è Clear Token</button>
            </div>
            
            <div style="margin-top: 10px;">
                <button class="test-button" onclick="checkAuthentication()">üß™ Test Authentication & Run All Tests</button>
                <button class="test-button" onclick="initiateGoogleAuth()">üìñ Authentication Setup Guide</button>
                <button class="test-button" onclick="showAuthInstructions()">‚ùì Quick Instructions</button>
                <button class="test-button" onclick="runAllTests()" style="background: linear-gradient(45deg, #4ecdc4, #44e08e);">üöÄ Run All Tests Now</button>
            </div>
        </div>

        <div class="test-grid">
            <div class="test-card">
                <h3>üè• Health Check</h3>
                <p>Basic API health and connectivity test</p>
                <button class="test-button" onclick="testHealth()">Test Health</button>
                <div id="health-result" class="result-box" style="display:none;"></div>
            </div>

            <div class="test-card">
                <h3>üìä System Status</h3>
                <p>Complete system metrics and component status</p>
                <button class="test-button" onclick="testSystemStatus()">Test System</button>
                <div id="system-result" class="result-box" style="display:none;"></div>
            </div>

            <div class="test-card">
                <h3>ü§ñ Pattern Discovery</h3>
                <p>AI pattern discovery engine initialization</p>
                <button class="test-button" onclick="testPatternDiscovery()">Test Patterns</button>
                <div id="pattern-result" class="result-box" style="display:none;"></div>
            </div>

            <div class="test-card">
                <h3>üìà Live Patterns</h3>
                <p>Real-time trading pattern data feed</p>
                <button class="test-button" onclick="testLivePatterns()">Test Live Data</button>
                <div id="live-result" class="result-box" style="display:none;"></div>
            </div>

            <div class="test-card">
                <h3>‚ö° Performance Test</h3>
                <p>API response time and latency analysis</p>
                <button class="test-button" onclick="testPerformance()">Test Performance</button>
                <div id="performance-result" class="result-box" style="display:none;"></div>
            </div>

            <div class="test-card">
                <h3>üîó CORS & Integration</h3>
                <p>Cross-origin requests and browser compatibility</p>
                <button class="test-button" onclick="testCORS()">Test CORS</button>
                <div id="cors-result" class="result-box" style="display:none;"></div>
            </div>
        </div>

        <div class="test-card">
            <h3>üìä Live System Metrics</h3>
            <div class="metrics-grid" id="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="patterns-count">---</div>
                    <div class="metric-label">Patterns Discovered</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="response-time">---</div>
                    <div class="metric-label">Response Time (ms)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="system-load">---</div>
                    <div class="metric-label">System Load</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="active-alerts">---</div>
                    <div class="metric-label">Active Alerts</div>
                </div>
            </div>
            <button class="test-button" onclick="refreshMetrics()">üîÑ Refresh Metrics</button>
        </div>

        <div class="footer">
            <p>üåü <strong>Quantora Development Beast</strong> - Revolutionary AI Trading Platform</p>
            <p>Enterprise-grade infrastructure with Steve Jobs quality standards</p>
            <p><em>"Making the impossible possible"</em> ‚ú®</p>
        </div>
    </div>

    <script>
        // Smart environment detection
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isProduction = window.location.hostname.includes('github.io') || window.location.hostname.includes('shafitraders');
        
        // Dynamic API endpoint selection
        const API_ENDPOINTS = {
            local: 'http://localhost:8000',  // Your local backend
            production: 'https://quantora-production-api-387275137268.us-central1.run.app'
        };
        
        const API_BASE = isLocal ? API_ENDPOINTS.local : API_ENDPOINTS.production;
        const ENVIRONMENT = isLocal ? 'LOCAL DEVELOPMENT' : 'PRODUCTION';
        
        let authToken = null;

        // Authentication management functions
        function setAuthToken() {
            const tokenInput = document.getElementById('auth-token-input');
            const token = tokenInput.value.trim();
            
            if (token) {
                authToken = token;
                localStorage.setItem('quantora_auth_token', token);
                document.getElementById('auth-status').innerHTML = 
                    '<span class="status-indicator status-healthy"></span>Authentication token set! Ready for testing.';
                tokenInput.value = '';
                console.log('üîë Authentication token set');
            } else {
                alert('Please paste a valid token');
            }
        }

        function clearAuthToken() {
            authToken = null;
            localStorage.removeItem('quantora_auth_token');
            document.getElementById('auth-token-input').value = '';
            document.getElementById('auth-status').innerHTML = 
                '<span class="status-indicator status-warning"></span>No authentication token set';
            console.log('üóëÔ∏è Authentication token cleared');
        }

        // Enhanced authentication flow with better instructions
        async function initiateGoogleAuth() {
            const statusElement = document.getElementById('auth-status');
            statusElement.innerHTML = '<span class="status-indicator status-warning"></span>üîê Starting enhanced authentication flow...';
            
            // Provide detailed instructions and auto-check gcloud availability
            const instructions = `
üîë ENHANCED AUTHENTICATION GUIDE

STEP 1: Install Google Cloud CLI (if not already installed)
   Option A: Direct installer
   ‚Ä¢ Visit: https://cloud.google.com/sdk/docs/install
   ‚Ä¢ Download for your OS and follow setup
   
   Option B: Command line
   ‚Ä¢ Mac: brew install google-cloud-sdk
   ‚Ä¢ Windows: Download .exe installer
   ‚Ä¢ Linux: curl https://sdk.cloud.google.com | bash

STEP 2: Authenticate and Configure
   Open terminal and run these commands:
   
   1) gcloud auth login
      ‚Üí Opens browser, sign in with Google account
   
   2) gcloud config set project quantora-parallel-dev
      ‚Üí Sets the correct project context
   
   3) gcloud auth print-identity-token
      ‚Üí Generates your authentication token
   
   4) Copy the token and paste it above, then click "üíæ Set Token"

STEP 3: Verify Authentication
   ‚Ä¢ Click "üß™ Test Authentication & Run All Tests"
   ‚Ä¢ System will validate token and auto-run all tests

‚ú® Pro Tips:
‚Ä¢ Tokens expire after 1 hour - regenerate as needed
‚Ä¢ Keep terminal open for easy token refresh
‚Ä¢ Use "gcloud auth list" to check active accounts

Ready to start? The process takes about 2 minutes total.
            `;
            
            // Create a more sophisticated dialog
            const proceed = confirm(instructions + "\n\nClick OK to open Google Cloud installation guide, or Cancel to continue with manual setup.");
            
            if (proceed) {
                // Open official Google Cloud SDK installation page
                window.open('https://cloud.google.com/sdk/docs/install', '_blank');
                statusElement.innerHTML = '<span class="status-indicator status-healthy"></span>üìñ Installation guide opened. Follow steps above, then return here to set your token.';
            } else {
                statusElement.innerHTML = '<span class="status-indicator status-healthy"></span>üìã Use the manual authentication steps above. Run the gcloud commands in your terminal.';
            }
            
            // Auto-show the token input section
            document.getElementById('auth-input-section').style.display = 'block';
        }

        function showAuthInstructions() {
            const instructions = `
üîë QUICK AUTHENTICATION STEPS:

1Ô∏è‚É£ INSTALL (if needed): brew install google-cloud-sdk
2Ô∏è‚É£ LOGIN: gcloud auth login
3Ô∏è‚É£ PROJECT: gcloud config set project quantora-parallel-dev
4Ô∏è‚É£ TOKEN: gcloud auth print-identity-token
5Ô∏è‚É£ PASTE TOKEN above and click "üíæ Set Token"
6Ô∏è‚É£ TEST: Click "üß™ Test Authentication & Run All Tests"

‚è∞ Note: Tokens expire after 1 hour - regenerate as needed.

üí° For detailed setup guide, click "üìñ Authentication Setup Guide"
üöÄ For quick testing without auth setup, click "üöÄ Run All Tests Now"
            `;
            alert(instructions);
        }

        // Check authentication status and actually test it
        async function checkAuthentication() {
            const statusElement = document.getElementById('auth-status');
            const authInputSection = document.getElementById('auth-input-section');
            
            statusElement.innerHTML = '‚è≥ Testing authentication...';
            
            if (isLocal) {
                // Local development - no auth required, test directly
                statusElement.innerHTML = '<span class="status-indicator status-healthy"></span>Local environment - testing without auth...';
                authInputSection.style.display = 'none';
                
                // Auto-run tests for local environment
                setTimeout(() => {
                    runAllTests();
                }, 1000);
                return;
            } else {
                // Production - requires Google Cloud Identity Token
                authInputSection.style.display = 'block';
                
                // Check if we have a stored token
                const storedToken = localStorage.getItem('quantora_auth_token');
                if (storedToken) {
                    authToken = storedToken;
                    statusElement.innerHTML = '<span class="status-indicator status-healthy"></span>Testing stored token...';
                    
                    // Actually test the token by making a real API call
                    try {
                        const response = await fetch(`${API_BASE}/health`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            }
                        });
                        
                        if (response.ok) {
                            statusElement.innerHTML = '<span class="status-indicator status-healthy"></span>‚úÖ Authentication successful! Auto-running all tests...';
                            // Auto-run all tests after successful authentication
                            setTimeout(() => {
                                runAllTests();
                            }, 1500);
                        } else if (response.status === 401 || response.status === 403) {
                            statusElement.innerHTML = '<span class="status-indicator status-error"></span>‚ùå Token expired or invalid. Please get a new token.';
                            clearAuthToken();
                        } else {
                            statusElement.innerHTML = '<span class="status-indicator status-warning"></span>‚ö†Ô∏è Unexpected response. Check your connection.';
                        }
                    } catch (error) {
                        console.error('Auth test failed:', error);
                        
                        // Check if it's a CORS error
                        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                            statusElement.innerHTML = '<span class="status-indicator status-error"></span>‚ùå CORS/Network Error. Cloud Run IAM blocking requests. <br/>‚úÖ Your token is likely valid - the issue is service-level permissions.';
                        } else {
                            statusElement.innerHTML = '<span class="status-indicator status-error"></span>‚ùå Connection failed. Check network and API endpoint.';
                        }
                    }
                } else {
                    statusElement.innerHTML = '<span class="status-indicator status-warning"></span>No authentication token set - Click "‚ùì How to Get Token" for instructions';
                }
            }
        }

        // Run all tests automatically
        async function runAllTests() {
            console.log('üß™ Running all tests automatically...');
            console.log('üîó API Base:', API_BASE);
            console.log('üåç Environment:', ENVIRONMENT);
            console.log('üîë Auth Token Set:', !!authToken);
            
            // Add visual indicator
            document.body.style.border = '3px solid #00d4ff';
            document.body.style.boxShadow = '0 0 20px rgba(0, 212, 255, 0.3)';
            
            // Show running status
            const allResults = [
                'health-result', 'system-result', 'pattern-result', 
                'live-result', 'performance-result'
            ];
            
            allResults.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'block';
                    element.textContent = '‚è≥ Queued for testing...';
                }
            });
            
            // Run tests with delays and better error handling
            try {
                console.log('üè• Testing health...');
                await testHealth();
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                console.log('üìä Testing system status...');
                await testSystemStatus();
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                console.log('ü§ñ Testing pattern discovery...');
                await testPatternDiscovery();
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                console.log('üìà Testing live patterns...');
                await testLivePatterns();
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                console.log('‚ö° Testing performance...');
                await testPerformance();
                
                console.log('‚úÖ All tests completed!');
            } catch (error) {
                console.error('‚ùå Test suite error:', error);
            }
            
            // Remove visual indicator
            document.body.style.border = 'none';
            document.body.style.boxShadow = 'none';
        }

        // Utility function to make authenticated API calls
        async function makeAuthenticatedRequest(endpoint) {
            const url = `${API_BASE}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // Add authentication header if token is available
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
                console.log('üîë Making authenticated request to:', url);
                console.log('üé´ Token length:', authToken.length);
            } else {
                console.log('‚ö†Ô∏è Making unauthenticated request to:', url);
            }
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors'
                });
                
                console.log('üì° Response status:', response.status, response.statusText);
                console.log('üìã Response headers:', Object.fromEntries(response.headers.entries()));
                
                return response;
            } catch (error) {
                console.error('üö® Request failed:', error);
                throw error;
            }
        }

        // Test functions
        async function testHealth() {
            const resultDiv = document.getElementById('health-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '‚è≥ Testing health endpoint...';

            // Check authentication for production
            if (!isLocal && !authToken) {
                resultDiv.textContent = `‚ö†Ô∏è Authentication Required:
Production API requires authentication token.
Click "‚ùì How to Get Token" for instructions.

Environment: ${ENVIRONMENT}
API Endpoint: ${API_BASE}`;
                return;
            }

            try {
                const start = Date.now();
                const response = await makeAuthenticatedRequest('/health');
                const end = Date.now();
                
                if (response.status === 401 || response.status === 403) {
                    resultDiv.textContent = `üîê Authentication Error:
Status: ${response.status} (${response.status === 401 ? 'Unauthorized' : 'Forbidden'})
Response Time: ${end - start}ms

Your authentication token may be:
‚Ä¢ Expired (tokens last 1 hour)
‚Ä¢ Invalid for this project
‚Ä¢ Missing required permissions

Try running: gcloud auth print-identity-token
Then paste the new token above.`;
                    return;
                }
                
                const data = await response.json();
                const result = `‚úÖ Health Check Results:
Status: ${response.status} (${response.ok ? 'Success' : 'Failed'})
Response Time: ${end - start}ms
Environment: ${ENVIRONMENT}
Data: ${JSON.stringify(data, null, 2)}`;
                resultDiv.textContent = result;
                
            } catch (error) {
                const errorMessage = isLocal ? 
                    `‚ùå Health Check Failed:
Error: ${error.message}
Note: Make sure your local backend is running on port 8000.

Try running: python backend/main.py` :
                    `‚ùå Health Check Failed:
Error: ${error.message}

Possible causes:
‚Ä¢ Network connectivity issues
‚Ä¢ Invalid authentication token
‚Ä¢ API endpoint unreachable

Environment: ${ENVIRONMENT}
API Endpoint: ${API_BASE}`;
                    
                resultDiv.textContent = errorMessage;
            }
        }

        async function testSystemStatus() {
            const resultDiv = document.getElementById('system-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '‚è≥ Testing system status...';

            // Check authentication for production
            if (!isLocal && !authToken) {
                resultDiv.textContent = `‚ö†Ô∏è Authentication Required:
Production API requires authentication token for system status.
Click "‚ùì How to Get Token" for instructions.`;
                return;
            }

            try {
                const start = Date.now();
                const response = await makeAuthenticatedRequest('/system/status');
                const end = Date.now();
                
                if (response.status === 401 || response.status === 403) {
                    resultDiv.textContent = `üîê Authentication Error:
Status: ${response.status} - ${response.status === 401 ? 'Token Invalid/Expired' : 'Access Forbidden'}
Response Time: ${end - start}ms

Please refresh your authentication token.`;
                    return;
                }
                
                const data = await response.json();
                const result = `‚úÖ System Status Results:
Status: ${response.status} (${response.ok ? 'Operational' : 'Issues Detected'})
Response Time: ${end - start}ms
Environment: ${ENVIRONMENT}
Data: ${JSON.stringify(data, null, 2)}

Patterns Discovered: ${data.metrics?.patterns_discovered || 'N/A'}
System Load: ${data.metrics?.system_load || 'N/A'}
Active Alerts: ${data.metrics?.active_alerts || 'N/A'}`;
                
                resultDiv.textContent = result;
                
                // Update metrics if successful
                if (data.metrics) {
                    updateMetrics(data.metrics);
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå System Status Failed:
Error: ${error.message}
Environment: ${ENVIRONMENT}

${isLocal ? 'Make sure your local backend is running.' : 'Check your authentication token and network connection.'}`;
            }
        }

        async function testPatternDiscovery() {
            const resultDiv = document.getElementById('pattern-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '‚è≥ Testing pattern discovery...';

            try {
                const start = Date.now();
                const response = await makeAuthenticatedRequest('/pattern-discovery/initialize');
                const end = Date.now();
                const data = await response.json();
                
                const result = `‚úÖ Pattern Discovery Results:
Status: ${response.status}
Response Time: ${end - start}ms
Data: ${JSON.stringify(data, null, 2)}`;
                resultDiv.textContent = result;
            } catch (error) {
                resultDiv.textContent = `‚ùå Pattern Discovery Failed:
Error: ${error.message}
Note: Authentication required for pattern discovery`;
            }
        }

        async function testLivePatterns() {
            const resultDiv = document.getElementById('live-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '‚è≥ Testing live patterns...';

            try {
                const start = Date.now();
                const response = await makeAuthenticatedRequest('/patterns/live');
                const end = Date.now();
                const data = await response.json();
                
                const result = `${response.ok ? '‚úÖ' : '‚ö†Ô∏è'} Live Patterns Results:
Status: ${response.status}
Response Time: ${end - start}ms
Data: ${JSON.stringify(data, null, 2)}`;
                resultDiv.textContent = result;
            } catch (error) {
                resultDiv.textContent = `‚ùå Live Patterns Failed:
Error: ${error.message}
Note: Known issue - generate_demo_patterns function needs to be implemented`;
            }
        }

        async function testPerformance() {
            const resultDiv = document.getElementById('performance-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '‚è≥ Running performance tests...';

            const tests = [];
            const iterations = 5;

            for (let i = 0; i < iterations; i++) {
                try {
                    const start = Date.now();
                    await makeAuthenticatedRequest('/health');
                    const end = Date.now();
                    tests.push(end - start);
                } catch (error) {
                    tests.push(-1);
                }
            }

            const validTests = tests.filter(t => t > 0);
            const avgTime = validTests.length > 0 ? validTests.reduce((a, b) => a + b) / validTests.length : 0;
            const minTime = validTests.length > 0 ? Math.min(...validTests) : 0;
            const maxTime = validTests.length > 0 ? Math.max(...validTests) : 0;

            const result = `üìä Performance Test Results (${iterations} iterations):
Average Response Time: ${avgTime.toFixed(2)}ms
Minimum Response Time: ${minTime}ms
Maximum Response Time: ${maxTime}ms
Success Rate: ${(validTests.length / iterations * 100).toFixed(1)}%
Individual Tests: ${tests.join('ms, ')}ms`;
            
            resultDiv.textContent = result;
        }

        async function testCORS() {
            const resultDiv = document.getElementById('cors-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '‚è≥ Testing CORS configuration...';

            try {
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'OPTIONS'
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };

                const result = `‚úÖ CORS Configuration:
Status: ${response.status}
Headers: ${JSON.stringify(corsHeaders, null, 2)}
Browser Support: ‚úÖ Modern browsers supported
Cross-Origin: ${corsHeaders['Access-Control-Allow-Origin'] ? '‚úÖ Configured' : '‚ö†Ô∏è May be restricted'}`;
                
                resultDiv.textContent = result;
            } catch (error) {
                resultDiv.textContent = `‚ùå CORS Test Failed:
Error: ${error.message}
This may indicate CORS restrictions or network issues`;
            }
        }

        function updateMetrics(metrics) {
            document.getElementById('patterns-count').textContent = metrics.patterns_discovered || '---';
            document.getElementById('response-time').textContent = metrics.response_time_ms || '---';
            document.getElementById('system-load').textContent = metrics.system_load || '---';
            document.getElementById('active-alerts').textContent = metrics.active_alerts || '---';
        }

        async function refreshMetrics() {
            try {
                const response = await makeAuthenticatedRequest('/system/status');
                const data = await response.json();
                if (data.metrics) {
                    updateMetrics(data.metrics);
                }
            } catch (error) {
                console.log('Metrics refresh failed:', error.message);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Quantora API Testing Platform Loaded');
            
            // Add environment indicator
            const envIndicator = document.createElement('div');
            envIndicator.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: ${isLocal ? 'linear-gradient(45deg, #ff6b6b, #ffd93d)' : 'linear-gradient(45deg, #00d4ff, #4ecdc4)'};
                color: white;
                padding: 8px 15px;
                border-radius: 20px;
                font-weight: bold;
                font-size: 12px;
                z-index: 9999;
                box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                animation: pulse 2s infinite;
            `;
            envIndicator.textContent = `üåç ${ENVIRONMENT}`;
            document.body.appendChild(envIndicator);
            
            // Update environment info in the page
            document.getElementById('env-name').textContent = ENVIRONMENT;
            document.getElementById('env-name').style.color = isLocal ? '#ffd93d' : '#00d4ff';
            document.getElementById('api-url').textContent = API_BASE;
            document.getElementById('auth-method').textContent = isLocal ? 
                'Development Mode (No Auth Required)' : 
                'Google Cloud Identity Token Required';
            
            console.log(`üöÄ Environment: ${ENVIRONMENT}`);
            console.log(`üîó API Base: ${API_BASE}`);
            
            checkAuthentication();
            
            // Auto-refresh metrics every 30 seconds
            setInterval(refreshMetrics, 30000);
        });
    </script>
</body>
</html>